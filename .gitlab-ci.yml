stages:
  - mirror
  - build
  - docstats

mirror_repo:
  stage: mirror
  only:
    - master
    - develop
  script:
    - git checkout master
    - git pull origin master
    - git push git@github.com:namboy94/mal-tournament.git master --force
    - git checkout develop
    - git pull origin develop
    - git push git@github.com:namboy94/mal-tournament.git develop --force

build_release:
  stage: build
  only:
    - master
  script:
    - gradle build
    - ./gradlew assembleRelease -Pandroid.injected.signing.store.file=$ANDROIDKEY_LOCATION
      Pandroid.injected.signing.store.password=$ANDROIDKEY_PASS
      Pandroid.injected.signing.key.alias=$ANDROIDKEY_ALIAS
      Pandroid.injected.signing.key.password=$ANDROIDKEY_PASS
    - python noanalytics.py stash
    - python noanalytics.py deactivate
    - ./gradlew assembleRelease -Pandroid.injected.signing.store.file=$ANDROIDKEY_LOCATION
      Pandroid.injected.signing.store.password=$ANDROIDKEY_PASS
      Pandroid.injected.signing.key.alias=$ANDROIDKEY_ALIAS
      Pandroid.injected.signing.key.password=$ANDROIDKEY_PASS
    - python noanalytics.py restore
    - python github-release.py $GITHUBAUTH

  artifacts:
    paths:
      - java/build/libs

generate_git_stats:
  stage: docstats
  only:
    - master
    - develop
  script:
    - gitstats . git_stats
    - rsync -av git_stats/ www.krumreyh.com@ssh.strato.de:~/programming_pages/mal-tournament/git_stats --delete-after
